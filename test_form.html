<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Form</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .error { color: red; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>Test Donor Form</h1>

    <div id="donor-form-view">
        <form class="space-y-8">
            <div class="form-group">
                <label>Brand Name*</label>
                <input type="text" name="brand" placeholder="e.g. Steinway, Yamaha, Kawai" required>
            </div>

            <div class="form-group">
                <label>Model</label>
                <input type="text" name="model" placeholder="e.g. U1, Model B">
            </div>

            <div class="form-group">
                <label>Serial #</label>
                <input type="text" name="serial" placeholder="Found inside the piano">
            </div>

            <div class="form-group">
                <label>Approx. Year</label>
                <input type="number" name="year" placeholder="e.g. 1995" min="1800" max="2025">
            </div>

            <div class="form-group">
                <label>Type*</label>
                <select name="type" required>
                    <option value="">Select Type</option>
                    <option>Upright Piano</option>
                    <option>Grand Piano</option>
                    <option>Digital Piano</option>
                </select>
            </div>

            <div class="form-group">
                <label>Height / Length</label>
                <input type="text" name="height_length" placeholder="In inches or cm">
            </div>

            <div class="form-group">
                <label>Finish / Color</label>
                <input type="text" name="finish" placeholder="e.g. Polished Ebony, Walnut">
            </div>

            <div class="form-group">
                <label>Condition*</label>
                <select name="condition" required>
                    <option value="">Select Condition</option>
                    <option>Excellent - Like new</option>
                    <option>Good - Playable with minor wear</option>
                    <option>Fair - Needs tuning or minor repair</option>
                    <option>Poor - Needs major restoration</option>
                </select>
            </div>

            <div class="form-group">
                <label>Finish / Color (details)</label>
                <input type="text" name="color_wood" placeholder="e.g. Black Mahogany, White Oak">
            </div>

            <div class="form-group">
                <label>City & State*</label>
                <input type="text" name="city" placeholder="e.g. Manhattan, NY" required>
            </div>

            <div class="form-group">
                <label>Access Details</label>
                <textarea name="access" rows="3" placeholder="e.g. 2nd floor, service elevator available"></textarea>
            </div>

            <button type="submit">Submit Registry</button>
        </form>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 400px;">
            <h3>Success!</h3>
            <p id="success-message">Thank you for registering your piano!</p>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        // Include the same functions from script.js
        function showFieldError(field, message) {
            clearFieldError(field);
            field.style.borderColor = 'red';

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;

            field.parentNode.insertBefore(errorDiv, field.nextSibling);
        }

        function clearFieldError(field) {
            field.style.borderColor = '#ccc';
            const errorDiv = field.parentNode.querySelector('.error');
            if (errorDiv) {
                errorDiv.remove();
            }
        }

        function validateDonorForm(form) {
            console.log('Validating donor form...');
            let isValid = true;
            const requiredFields = ['brand', 'type', 'condition', 'city'];

            requiredFields.forEach(fieldName => {
                const field = form.querySelector(`[name="${fieldName}"]`);
                console.log(`Checking field ${fieldName}:`, field ? field.value : 'field not found');
                if (field && !field.value.trim()) {
                    console.log(`Field ${fieldName} is required but empty`);
                    showFieldError(field, 'This field is required');
                    isValid = false;
                } else if (field) {
                    clearFieldError(field);
                }
            });

            const yearField = form.querySelector('[name="year"]');
            if (yearField && yearField.value.trim()) {
                const year = parseInt(yearField.value);
                if (isNaN(year) || year < 1800 || year > new Date().getFullYear()) {
                    showFieldError(yearField, 'Please enter a valid year');
                    isValid = false;
                } else {
                    clearFieldError(yearField);
                }
            }

            console.log('Validation result:', isValid);
            return isValid;
        }

        function showSuccessModal(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('success-modal').style.display = 'none';
        }

        async function submitFormData(endpoint, data) {
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                result.success = response.ok;
                return result;
            } catch (error) {
                console.error('Network error:', error);
                throw new Error('Network connection failed');
            }
        }

        // Form submission
        document.addEventListener('DOMContentLoaded', function() {
            const donorForm = document.querySelector('#donor-form-view form');
            if (donorForm) {
                donorForm.addEventListener('submit', function(e) {
                    e.preventDefault();

                    console.log('Form submitted, validating...');
                    if (!validateDonorForm(this)) {
                        console.log('Form validation failed');
                        return;
                    }
                    console.log('Form validation passed');

                    const submitBtn = this.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';

                    const formData = new FormData(this);
                    const data = {
                        manufacturer: formData.get('brand') || '',
                        model: formData.get('model') || '',
                        serial: formData.get('serial') || '',
                        year: parseInt(formData.get('year')) || 2020,
                        height: formData.get('height_length') || '',
                        finish: formData.get('condition') || '',
                        color_wood: formData.get('color_wood') || '',
                        city_state: formData.get('city') || ''
                    };

                    console.log('Submitting data:', data);
                    submitFormData('/api/registration', data)
                        .then(response => {
                            console.log('Response received:', response);
                            if (response.id && response.message) {
                                console.log('Success! Showing modal...');
                                showSuccessModal('Thank you for registering your piano! A specialist will contact you within 48 hours for assessment.');
                                this.reset();
                            } else {
                                console.log('Error response:', response);
                                alert('Submission failed: ' + (response.message || 'Please try again.'));
                            }
                        })
                        .catch(error => {
                            console.error('Error submitting donor form:', error);
                            alert('Network error. Please check your connection and try again.');
                        })
                        .finally(() => {
                            submitBtn.disabled = false;
                            submitBtn.textContent = 'Submit Registry';
                        });
                });
            }
        });
    </script>
</body>
</html>


