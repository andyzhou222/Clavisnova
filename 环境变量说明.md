# Clavisnova 环境变量详细说明

本文档详细解释项目中使用的所有环境变量，包括其作用、配置方法和示例值。

## 📋 环境变量分类

### 1. Flask 应用配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `FLASK_ENV` | `production` | ✅ | Flask 运行环境<br>• `development`: 开发环境，显示详细错误信息<br>• `production`: 生产环境，错误信息简化 |
| `SECRET_KEY` | - | ✅ | Flask 应用密钥，用于 session 和安全功能<br>• 生产环境必须设置唯一且安全的密钥<br>• 示例: `your-secret-key-here-change-this-in-production` |
| `HOST` | `0.0.0.0` | ❌ | Flask 服务器监听的主机地址<br>• `0.0.0.0`: 监听所有网络接口<br>• `127.0.0.1`: 仅本地访问 |
| `PORT` | `8080` | ❌ | Flask 服务器监听的端口号<br>• Render 会自动设置此变量<br>• 本地开发可使用 8080 |
| `DEBUG` | `false` | ❌ | 是否启用调试模式<br>• `true`: 显示详细错误和重载代码<br>• `false`: 生产环境禁用 |

### 2. 数据库配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `DATABASE_URL` | - | ✅ | 数据库连接字符串<br>• **Supabase PostgreSQL** (推荐): `postgresql+psycopg2://postgres:PASSWORD@db.PROJECT-REF.supabase.co:5432/postgres`<br>• **SQLite** (仅开发): `sqlite:///app/data/Clavisnova.db` |

**Supabase 配置步骤:**
1. 登录 Supabase 控制台
2. 进入 Settings → Database
3. 复制 "Connection string" (选择 URI 格式)
4. 添加 `+psycopg2` 驱动前缀

### 3. CORS 跨域配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `CORS_ORIGINS` | - | ✅ | 允许的跨域来源，用逗号分隔<br>• 包含您的 Cloudflare Pages 域名<br>• 示例: `https://your-frontend.pages.dev,https://your-render-app.onrender.com` |

### 4. 日志配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `LOG_LEVEL` | `INFO` | ❌ | 日志级别<br>• `DEBUG`: 最详细，包括调试信息<br>• `INFO`: 普通信息 (默认)<br>• `WARNING`: 仅警告和错误<br>• `ERROR`: 仅错误 |
| `LOG_MAX_SIZE` | `10485760` | ❌ | 单个日志文件最大大小 (字节)<br>• 默认: 10MB<br>• 数字格式，如: `10485760` |
| `LOG_RETENTION` | `30` | ❌ | 日志文件保留天数<br>• 默认: 30天<br>• 过期日志自动删除 |

### 5. 版本信息

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `VERSION` | `1.0.0` | ❌ | 应用版本号<br>• 用于 API 响应和健康检查<br>• 格式: `x.y.z` |

### 6. 前端配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `FRONTEND_URL` | - | ✅ | 前端应用 URL (Cloudflare Pages)<br>• 用于 CORS 和重定向<br>• 示例: `https://your-project.pages.dev` |

### 7. 邮件通知配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `MAIL_SERVER` | `smtp.gmail.com` | ✅ | SMTP 服务器地址<br>• Gmail: `smtp.gmail.com`<br>• Outlook: `smtp-mail.outlook.com`<br>• QQ邮箱: `smtp.qq.com`<br>• 163邮箱: `smtp.163.com` |
| `MAIL_PORT` | `587` | ✅ | SMTP 服务器端口<br>• TLS (587): Gmail, Outlook<br>• SSL (465): QQ邮箱, 163邮箱 |
| `MAIL_USE_TLS` | `true` | ✅ | 是否使用 TLS 加密<br>• Gmail/Outlook: `true`<br>• QQ邮箱/163邮箱: `false` |
| `MAIL_USE_SSL` | `false` | ✅ | 是否使用 SSL 加密<br>• Gmail/Outlook: `false`<br>• QQ邮箱/163邮箱: `true` |
| `MAIL_USERNAME` | - | ✅ | 发件邮箱地址<br>• **需要您自己准备的邮箱账户**<br>• 不支持 Cloudflare Pages 提供的邮箱<br>• 示例: `your-email@gmail.com` |
| `MAIL_PASSWORD` | - | ✅ | 邮箱密码或应用密码<br>• Gmail 必须使用应用密码（非登录密码）<br>• 其他邮箱使用授权码或密码<br>• **安全提醒**: 不要使用真实登录密码 |
| `MAIL_DEFAULT_SENDER` | - | ✅ | 默认发件人地址<br>• 通常与 MAIL_USERNAME 相同<br>• 用于邮件的 From 字段 |
| `NOTIFICATION_EMAIL` | - | ✅ | 通知接收邮箱<br>• 您想要接收通知的邮箱<br>• 可以是任何有效的邮箱地址 |

### 8. Render 平台配置

| 变量名 | 默认值 | 必需 | 说明 |
|--------|--------|------|------|
| `RENDER_EXTERNAL_URL` | - | ❌ | Render 自动设置的外部 URL<br>• 格式: `https://your-app.onrender.com`<br>• 不要手动设置，由 Render 自动提供 |

## 🔧 配置方法

### 在 Render 上配置

1. 登录 [Render 控制台](https://render.com)
2. 选择您的 Clavisnova 应用
3. 点击 **Environment** 标签页
4. 点击 **Add Environment Variable**
5. 填写变量名和值
6. 保存后会自动重新部署

### 本地开发配置

1. 复制 `env.example` 为 `.env`
2. 填入实际值
3. 确保 `.env` 在 `.gitignore` 中

```bash
cp env.example .env
# 编辑 .env 文件
```

## ⚠️ 安全注意事项

### 🔐 敏感信息保护
- **不要提交真实密码到 Git**
- **使用应用密码而非账户密码**
- **定期轮换敏感凭据**
- **限制环境变量访问权限**

### 📧 邮件配置安全
- **Gmail**: 使用应用密码而非账户密码
- **企业邮箱**: 使用授权码而非账户密码
- **测试邮件功能**: 先在本地测试

## 🔍 故障排除

### 常见问题

**应用无法启动**
- 检查必需的环境变量是否都已设置
- 确认数据库 URL 格式正确

**邮件发送失败**
- 验证邮箱服务器设置
- 检查是否使用了正确的端口和加密方式
- 确认密码/应用密码正确

**数据库连接失败**
- 检查 Supabase 项目状态
- 确认连接字符串格式
- 验证密码和项目引用

**CORS 错误**
- 确认 FRONTEND_URL 设置正确
- 检查 CORS_ORIGINS 包含前端域名

### 调试技巧

1. **查看 Render 日志**
   - 登录 Render 控制台
   - 查看应用日志中的错误信息

2. **本地测试**
   - 使用 `.env` 文件设置变量
   - 运行 `python main.py` 测试

3. **健康检查**
   - 访问 `/api/health` 端点检查系统状态

## 📚 相关文档

- [Flask 环境变量](https://flask.palletsprojects.com/en/2.3.x/config/)
- [Supabase 连接字符串](https://supabase.com/docs/guides/database/connecting-to-postgres)
- [Render 环境变量](https://docs.render.com/environment-variables)
- [邮件配置指南](./邮件通知配置指南.md)

---

*最后更新: 2025年1月*
